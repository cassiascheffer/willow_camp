#!/bin/bash
# ABOUTME: Post-deployment script that notifies Discord and Honeybadger of successful deployment
# ABOUTME: Called after deployment to send notifications and track deployment metrics

set -e

echo "Running post-deployment tasks..."

# Discord webhook notification
echo "Sending Discord notification..."
COMMIT_MESSAGE=$(git log -1 --pretty=format:'%s')
curl -X POST "${DISCORD_WEBHOOK_URL}" \
  -H "Content-Type: application/json" \
  -d "{\"content\": \"üèïÔ∏è Willow Camp deployed successfully to ${RAILS_ENV:-production} \n\n**Latest commit:** ${COMMIT_MESSAGE}\"}\n\nHappy Camping! ‚òÄÔ∏è"

# Honeybadger deploy notification
echo "Notifying Honeybadger of deployment..."
bundle exec honeybadger deploy --environment "${RAILS_ENV:-production}" --revision "${REVISION}" --repository "https://github.com/cassiascheffer/willow_camp"

echo "Post-deployment tasks completed successfully!"
