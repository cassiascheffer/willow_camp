{{define "content"}}
<div class="flex flex-col items-center justify-center min-h-screen">
  <div class="card w-full lg:w-3/4">
    <div class="card-body" x-data="autosaveForm({{.IsEdit}}, '{{deref .Blog.Subdomain}}', '{{if .Post}}{{.Post.ID}}{{end}}', {{if .Post}}{{if .Post.Published}}{{if deref .Post.Published}}'true'{{else}}'false'{{end}}{{else}}'false'{{end}}{{else}}'false'{{end}})">
      <h1 class="card-title text-2xl font-bold">
        Editing post
      </h1>
      <div id="autosave_status" class="sticky top-0 z-10">
        <span x-show="saveStatus"
              x-transition
              class="badge badge-sm"
              :class="{
                'badge-neutral': saveStatus === 'saving',
                'badge-success': saveStatus === 'saved',
                'badge-error': saveStatus === 'error'
              }">
          <span x-text="saveStatusText"></span>
        </span>
      </div>
      <form method="POST"
            action="{{if .IsEdit}}/dashboard/blogs/{{deref .Blog.Subdomain}}/posts/{{.Post.ID}}{{else}}/dashboard/blogs/{{deref .Blog.Subdomain}}/posts{{end}}"
            id="post_form"
            class="form-control"
            x-ref="form"
            @submit="onSubmit"
            @change="markDirty"
            @keydown.window.prevent.meta.s="triggerAutosave"
            @keydown.window.prevent.ctrl.s="triggerAutosave">

        <!-- Title Field -->
        <div class="form-control w-full mb-4">
          <label class="label">Title</label>
          <input type="text"
                 name="title"
                 value="{{if .Post}}{{if .Post.Title}}{{deref .Post.Title}}{{end}}{{end}}"
                 class="input input-bordered w-full"
                 required
                 autofocus />
        </div>

        <!-- Slug and Tags Fields (side by side on lg) -->
        <div class="flex flex-col lg:flex-row lg:gap-4 mb-4">
          <div class="form-control w-full lg:w-1/2 mb-4 lg:mb-0">
            <div class="tooltip tooltip-top" data-tip="slugs are auto-generated">
              <label class="label">Slug</label>
              <input type="text"
                     name="slug"
                     value="{{if .Post}}{{if .Post.Slug}}{{deref .Post.Slug}}{{end}}{{end}}"
                     class="input input-bordered w-full"
                     disabled />
            </div>
          </div>
          <div class="form-control w-full lg:w-1/2" x-data="tagChoices({{toJSON .AllTags}}, '{{.TagsString}}')">
            <label class="label">Tag list</label>
            <input type="hidden" name="tags" value="{{.TagsString}}" x-ref="input" />
            <select multiple x-ref="select" class="w-full"></select>
          </div>
        </div>

        <!-- Meta Description -->
        <div class="form-control w-full mb-4">
          <label class="label">Meta Description</label>
          <textarea name="meta_description"
                    rows="2"
                    maxlength="255"
                    class="textarea textarea-bordered w-full">{{if .Post}}{{if .Post.MetaDescription}}{{deref .Post.MetaDescription}}{{end}}{{end}}</textarea>
        </div>

        <!-- Body Markdown -->
        <div class="form-control w-full mb-4">
          <label class="label">Body</label>
          <textarea name="body_markdown"
                    rows="20"
                    class="textarea textarea-bordered w-full font-mono"
                    style="min-height: 600px;"
                    placeholder="Write your post in markdown...">{{if .Post}}{{if .Post.BodyMarkdown}}{{deref .Post.BodyMarkdown}}{{end}}{{end}}</textarea>
          <div class="text-sm text-base-content/70 mt-2">
            {{heroicon "information-circle" "inline w-4 h-4"}}
            Image uploads are free for now but will be a paid feature in the future.
          </div>
        </div>

        <!-- Published Date -->
        <div class="form-control w-full mb-4">
          <label class="label">Published Date</label>
          <input type="datetime-local"
                 name="published_at"
                 value="{{if .Post}}{{if .Post.PublishedAt}}{{formatDateTime .Post.PublishedAt}}{{end}}{{end}}"
                 class="input input-bordered w-full" />
        </div>

        <!-- Buttons -->
        <div class="flex gap-4 mt-6">
          {{if .Post}}
            {{if .Post.Published}}
              {{if deref .Post.Published}}
                <input type="hidden" name="published" value="true" id="post_published" />
                <button type="submit"
                        class="btn btn-primary btn-soft w-full text-sm md:text-base"
                        :disabled="saving"
                        x-text="saving ? 'Saving...' : 'Save'">
                </button>
              {{else}}
                <input type="hidden" name="published" value="false" id="post_published" x-model="publishedValue" />
                <button type="submit"
                        class="btn btn-secondary btn-soft flex-1 text-sm md:text-base"
                        :disabled="saving"
                        x-text="saving ? 'Saving draft...' : 'Save draft'"
                        @click="publishedValue = 'false'">
                </button>
                <button type="submit"
                        class="btn btn-primary btn-soft flex-1 text-sm md:text-base"
                        :disabled="saving"
                        x-text="saving ? 'Publishing...' : 'Publish'"
                        @click="publishedValue = 'true'">
                </button>
              {{end}}
            {{else}}
              <input type="hidden" name="published" value="false" id="post_published" x-model="publishedValue" />
              <button type="submit"
                      class="btn btn-secondary btn-soft flex-1 text-sm md:text-base"
                      :disabled="saving"
                      x-text="saving ? 'Saving draft...' : 'Save draft'"
                      @click="publishedValue = 'false'">
              </button>
              <button type="submit"
                      class="btn btn-primary btn-soft flex-1 text-sm md:text-base"
                      :disabled="saving"
                      x-text="saving ? 'Publishing...' : 'Publish'"
                      @click="publishedValue = 'true'">
              </button>
            {{end}}
          {{else}}
            <input type="hidden" name="published" value="false" id="post_published" x-model="publishedValue" />
            <button type="submit"
                    class="btn btn-secondary btn-soft flex-1 text-sm md:text-base"
                    :disabled="saving"
                    x-text="saving ? 'Saving draft...' : 'Save draft'"
                    @click="publishedValue = 'false'">
            </button>
            <button type="submit"
                    class="btn btn-primary btn-soft flex-1 text-sm md:text-base"
                    :disabled="saving"
                    x-text="saving ? 'Publishing...' : 'Publish'"
                    @click="publishedValue = 'true'">
            </button>
          {{end}}
        </div>
      </form>

      {{if .IsEdit}}
      <!-- Post Actions -->
      <div class="mt-4" x-data="{ dropdownOpen: false }">
        <div class="lg:flex lg:justify-between">
          <div class="order-2 lg:order-1 mt-4 lg:mt-0">
            <a href="/dashboard/blogs/{{deref .Blog.Subdomain}}/posts" class="underline flex items-center gap-1">
              {{heroiconMini "arrow-left" "h-4 w-4"}}
              Back to Dashboard
            </a>
          </div>
          <div class="flex gap-2 justify-end order-1 lg:order-2">
            <div class="dropdown dropdown-end dropdown-top">
              <div tabindex="0" role="button" class="btn btn-outline" aria-label="Post actions menu">
                {{heroicon "ellipsis-vertical" "h-5 w-5"}}
              </div>
              <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box z-[1] w-52 p-2 shadow" aria-label="Post actions">
                <li>
                  {{if .Post.Published}}
                    {{if deref .Post.Published}}
                      <a href="https://{{if .Blog.Subdomain}}{{deref .Blog.Subdomain}}{{end}}.willow.camp/{{if .Post.Slug}}{{deref .Post.Slug}}{{end}}" target="_blank">
                        View post
                      </a>
                    {{else}}
                      <a href="/dashboard/blogs/{{deref .Blog.Subdomain}}/posts/{{.Post.ID}}/preview" target="_blank">
                        Preview post
                      </a>
                    {{end}}
                  {{else}}
                    <a href="/dashboard/blogs/{{deref .Blog.Subdomain}}/posts/{{.Post.ID}}/preview" target="_blank">
                      Preview post
                    </a>
                  {{end}}
                </li>
                {{if .Post.Published}}
                  {{if deref .Post.Published}}
                    <li>
                      <form method="POST" action="/dashboard/blogs/{{deref .Blog.Subdomain}}/posts/{{.Post.ID}}/unpublish">
                        <button type="submit">Unpublish</button>
                      </form>
                    </li>
                  {{end}}
                {{end}}
                <li>
                  <button type="button"
                          class="text-error"
                          @click="if(confirm('Are you sure you want to delete this post?')) { document.getElementById('delete_form').submit(); }">
                    Delete
                  </button>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <!-- Hidden delete form -->
      <form id="delete_form" method="POST" action="/dashboard/blogs/{{deref .Blog.Subdomain}}/posts/{{.Post.ID}}/delete" style="display: none;">
      </form>
      {{end}}
    </div>
  </div>
</div>
{{end}}
