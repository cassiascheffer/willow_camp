{{define "content"}}
<main aria-label="Blog Settings" class="container lg:w-3/4 mx-auto">
  <!-- Blog Details Section -->
  <section aria-label="Blog Details" class="mb-8">
    <h1 class="text-3xl font-bold mb-4">Blog Settings</h1>
    <div class="card p-4">
      <form method="POST" action="/dashboard/blogs/{{deref .Blog.Subdomain}}/settings" class="space-y-4" x-data="domainDowncase()">
        <!-- Title and Favicon Emoji Row -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
          <!-- Title Field -->
          <div class="form-control w-full">
            <label class="label">
              <span class="label-text">Blog Title</span>
            </label>
            <input type="text" name="title" value="{{if .Blog.Title}}{{.Blog.Title}}{{end}}" class="input input-bordered w-full" />
          </div>

          <!-- Favicon Emoji Field with Picker -->
          <div class="form-control w-full" x-data="emojiPicker('{{deref .Blog.Subdomain}}')">
            <label class="label">
              <span class="label-text">Favicon emoji</span>
            </label>
            <input type="hidden" name="favicon_emoji" value="{{if .Blog.FaviconEmoji}}{{.Blog.FaviconEmoji}}{{end}}" x-ref="input" />
            <select x-ref="select" class="w-full"></select>
            <div class="text-xs text-gray-500 mt-1">Search and select an emoji for your blog's favicon</div>
          </div>
        </div>

        <!-- Subdomain and Custom Domain Row -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
          <!-- Subdomain Field -->
          <div class="form-control w-full">
            <label class="label">
              <span class="label-text">Subdomain</span>
            </label>
            <input type="text"
                   name="subdomain"
                   value="{{if .Blog.Subdomain}}{{.Blog.Subdomain}}{{end}}"
                   required
                   class="input input-bordered w-full"
                   autocapitalize="off"
                   @input="downcaseInput($event)" />
            <div class="text-xs text-gray-500 mt-1">Your blog will be available at {{if .Blog.Subdomain}}{{.Blog.Subdomain}}{{end}}.willow.camp</div>
          </div>

          <!-- Custom Domain Field -->
          <div class="form-control w-full">
            <label class="label">
              <span class="label-text">Custom Domain (optional)</span>
            </label>
            <input type="text"
                   name="custom_domain"
                   value="{{if .Blog.CustomDomain}}{{.Blog.CustomDomain}}{{end}}"
                   placeholder="myblog.com"
                   class="input input-bordered w-full"
                   autocapitalize="off"
                   disabled
                   @input="downcaseInput($event)" />
            <div class="text-xs text-gray-500 mt-1">
              To set up a custom domain for your blog, please reach out on <a href="https://discord.gg/uZgMgtfpgC" class="link" target="_blank" rel="noopener">Discord</a>
            </div>
          </div>
        </div>

        <!-- Theme Selector -->
        <div class="form-control w-full mb-6" x-data="themeSelector('{{.Blog.Theme}}')">
          <label class="label">
            <span class="label-text">Theme</span>
          </label>
          <input type="hidden" name="theme" value="{{.Blog.Theme}}" x-ref="hiddenField" />

          <!-- Theme dropdown -->
          <div class="dropdown dropdown-end w-full">
            <div tabindex="0" role="button" class="btn btn-outline w-full justify-between normal-case">
              <div class="flex items-center gap-2">
                <div :data-theme="selectedTheme" x-ref="buttonPreview" class="bg-base-100 grid shrink-0 grid-cols-2 gap-0.5 rounded-md border border-base-content/10 p-1">
                  <div class="bg-base-content size-1 rounded-full"></div>
                  <div class="bg-primary size-1 rounded-full"></div>
                  <div class="bg-secondary size-1 rounded-full"></div>
                  <div class="bg-accent size-1 rounded-full"></div>
                </div>
                <span class="capitalize" x-text="selectedTheme" x-ref="buttonText"></span>
              </div>
              {{heroicon "chevron-down" "w-4 h-4"}}
            </div>
            <div tabindex="0" class="dropdown-content z-[1] menu p-2 shadow-lg bg-base-100 rounded-box w-full max-h-96 overflow-y-auto border border-base-300">
              <div class="menu-title text-xs mb-2">Choose a Theme</div>
              {{range allThemes}}
              <li>
                <button type="button"
                        class="flex items-center gap-3 p-2 hover:bg-base-200 rounded theme-option"
                        @click="selectTheme('{{.}}')">
                  <div data-theme="{{.}}" class="bg-base-100 grid shrink-0 grid-cols-2 gap-0.5 rounded-md border border-base-content/10 p-1">
                    <div class="bg-base-content size-1 rounded-full"></div>
                    <div class="bg-primary size-1 rounded-full"></div>
                    <div class="bg-secondary size-1 rounded-full"></div>
                    <div class="bg-accent size-1 rounded-full"></div>
                  </div>
                  <span class="capitalize flex-1 text-left">{{.}}</span>
                  <span x-show="selectedTheme === '{{.}}'">
                    {{heroicon "check" "w-4 h-4 text-primary"}}
                  </span>
                </button>
              </li>
              {{end}}
            </div>
          </div>
        </div>

        <!-- Meta Description -->
        <div class="form-control w-full mb-4">
          <label class="label">
            <span class="label-text">Site Meta Description</span>
          </label>
          <textarea name="meta_description"
                    class="textarea textarea-bordered w-full"
                    maxlength="255"
                    aria-describedby="site_meta_description_help">{{if .Blog.MetaDescription}}{{.Blog.MetaDescription}}{{end}}</textarea>
          <div id="site_meta_description_help" class="text-xs text-gray-500 mt-2">Used for SEO on index pages of your blog</div>
        </div>

        <!-- Post Footer -->
        <div class="form-control w-full mb-4">
          <label class="label">
            <span class="label-text">Post Footer</span>
          </label>
          <textarea name="post_footer_markdown"
                    class="textarea textarea-bordered w-full font-mono"
                    style="min-height: 200px;"
                    maxlength="10000"
                    aria-describedby="post_footer_help"
                    placeholder="Write your footer content in Markdown...">{{if .Blog.PostFooterMarkdown}}{{.Blog.PostFooterMarkdown}}{{end}}</textarea>
          <div id="post_footer_help" class="text-xs text-gray-500 mt-2">
            This footer will appear at the bottom of every blog post on this blog. You can use Markdown formatting.
          </div>
        </div>

        <!-- No Index Checkbox -->
        <div class="form-control mb-4">
          <label class="label cursor-pointer justify-start gap-2">
            <input type="checkbox" name="no_index" class="checkbox" {{if .Blog.NoIndex}}checked{{end}} />
            <span class="label-text">Tell search engines to not index my site</span>
          </label>
          <div class="text-xs text-gray-500 mt-1">When checked, search engines will be instructed not to crawl or index your blog</div>
        </div>

        <!-- Submit Button -->
        <div class="form-control w-full mt-6">
          <button type="submit" class="btn btn-primary w-full">Update blog settings</button>
        </div>
      </form>
    </div>
  </section>

  <!-- About Page Section -->
  <section aria-label="About Page" class="mb-8">
    <h1 class="text-3xl font-bold mb-4">About Page</h1>
    <div class="card p-4">
      <p class="text-zinc-500 text-sm pb-2">
        The About page will show up on the top nav next to the RSS link for this blog.
      </p>
      <form method="POST" action="/dashboard/blogs/{{deref .Blog.Subdomain}}/settings/about" class="space-y-4">
        <!-- Body Markdown Field -->
        <div class="form-control w-full mb-4">
          <label class="label">
            <span class="label-text">Body</span>
          </label>
          <textarea name="body_markdown"
                    class="textarea textarea-bordered w-full font-mono"
                    style="min-height: 300px;">{{if .AboutPage.BodyMarkdown}}{{.AboutPage.BodyMarkdown}}{{end}}</textarea>
        </div>

        <!-- Published Checkbox -->
        <div class="flex flex-col lg:flex-row lg:gap-4 lg:items-end mb-4">
          <div class="form-control w-full lg:w-auto mb-4 lg:mb-0">
            <label class="label">
              <span class="label-text">Published</span>
            </label>
            <div class="flex items-center h-12">
              <input type="checkbox" name="published" class="checkbox checkbox-primary" {{if .AboutPage.Published}}checked{{end}} />
            </div>
          </div>
        </div>

        <!-- Save and Delete Buttons -->
        <div class="form-control mt-6">
          <div class="flex flex-col lg:flex-row gap-2">
            <button type="submit" class="btn btn-primary w-full lg:w-auto">Save</button>
            {{if .AboutPage.ID}}
            <button type="button"
                    class="btn btn-error w-full lg:w-auto"
                    onclick="if(confirm('Are you sure you want to delete this page?')) { this.form.action='/dashboard/blogs/{{deref .Blog.Subdomain}}/settings/about/delete'; this.form.submit(); }">
              Delete Page
            </button>
            {{end}}
          </div>
        </div>
      </form>
    </div>
  </section>

  <!-- Danger Zone Section -->
  <section aria-label="Danger Zone" class="mb-8">
    <div class="collapse collapse-arrow border border-red-200 bg-red-50" x-data="blogDelete('{{if .Blog.Subdomain}}{{.Blog.Subdomain}}{{end}}')">
      <input type="checkbox" class="peer" />
      <div class="collapse-title text-xl font-medium text-red-600">
        {{heroicon "exclamation-triangle" "w-6 h-6 inline mr-2"}}
        Danger Zone
      </div>
      <div class="collapse-content">
        <div class="pt-4">
          <div class="flex items-start justify-between">
            <div>
              <h3 class="text-lg font-semibold text-red-900 mb-2">Delete this blog</h3>
              <p class="text-red-700 text-sm mb-4">
                Once you delete a blog, there is no going back. This will permanently delete the blog, all of its posts, pages, and associated data.
              </p>
            </div>
            <button type="button"
                    @click="confirmDelete()"
                    class="btn btn-error btn-outline">
              {{heroicon "trash" "w-4 h-4 mr-2"}}
              Delete Blog
            </button>
          </div>

          <!-- Hidden form for deletion -->
          <form method="POST" action="/dashboard/blogs/{{deref .Blog.Subdomain}}/delete" x-ref="deleteForm" style="display: none;"></form>

          <!-- First confirmation modal -->
          <div x-show="showModal"
               class="modal"
               :class="{ 'modal-open': showModal }">
            <div class="modal-box">
              <h3 class="font-bold text-lg text-red-600">Delete Blog</h3>
              <p class="py-4">
                To delete this blog, please type the subdomain <strong>{{if .Blog.Subdomain}}{{.Blog.Subdomain}}{{end}}</strong> to confirm:
              </p>
              <input type="text"
                     x-model="confirmationInput"
                     @input="checkMatch()"
                     x-ref="confirmInput"
                     class="input input-bordered w-full"
                     placeholder="Enter subdomain">
              <p x-show="errorMessage"
                 x-text="errorMessage"
                 class="text-red-600 text-sm mt-2"></p>
              <div class="modal-action">
                <button @click="cancelModal()" class="btn">Cancel</button>
                <button @click="proceedToFinal()"
                        :disabled="!isValid"
                        class="btn btn-error">Delete</button>
              </div>
            </div>
          </div>

          <!-- Final confirmation modal -->
          <div x-show="showFinalModal"
               class="modal"
               :class="{ 'modal-open': showFinalModal }">
            <div class="modal-box">
              <h3 class="font-bold text-lg text-red-600">Final Confirmation</h3>
              <p class="py-4">
                Are you absolutely sure? This will permanently delete the blog <strong>{{if .Blog.Subdomain}}{{.Blog.Subdomain}}{{end}}</strong> and all of its posts, pages, and associated data. This action cannot be undone.
              </p>
              <div class="modal-action">
                <button @click="cancelModal()" class="btn">Cancel</button>
                <button @click="deleteBlog()" class="btn btn-error">Yes, Delete Forever</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</main>

<style>
  [x-cloak] { display: none !important; }
</style>
{{end}}
